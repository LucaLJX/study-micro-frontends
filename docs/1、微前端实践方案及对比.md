
# 微前端实践方案及对比

## 微前端实践方案

> 《前端架构从入门到微前端》一书中，将微前端的实施分为六种

#### 一、路由分发
 
路由分发式微前端，即通过路由将不同的业务分发到不同的、独立前端应用上。其通常可以通过 HTTP 服务器的反向代理来实现，又或者是应用框架自带的路由来解决。

<img src="./images/微前端实践方案及对比/路由分发-方案示例.png">

#### 二、前端微服务

前端微服务化，是微服务架构在前端的实施，每个前端应用都是完全独立（技术栈、开发、部署、构建独立）、自主运行的，最后通过模块化的方式组合出完成的应用。

采用这种方式意味着，一个页面上可以同时存在两个以上的前端应用在运行。

<img src="./images/微前端实践方案及对比/前端微服务-方案示例.png">

目前主流的框架有 [Single-SPA](https://single-spa.js.org/)、[qiankun](https://qiankun.umijs.org/)、[Mooa](https://github.com/phodal/mooa)，后两者都是基于 `Single-SPA` 的封装。

#### 三、微应用
 
 微应用化是指在开发时应用都是以单一、微小应用的形式存在的，而在运行时，则是通过构建系统合并这些应用，并组合成一个新的应用。

 微应用化大都是以软件工程的方式来完成前端应用的聚合，因此又可以称之为组合式集成。

 微应用化只能使用唯一的一种前端框架。

 <img src="./images/微前端实践方案及对比/微应用-方案示例.png">

#### 四、微件化

 微件化（Widget）是一段可以直接嵌入应用上运行的代码，它由开发人员预先编译好，在加载时不需要再做任何修改或编译。微前端下的微件化是指，每个业务团第编写自己的业务代码，并将编译好的代码部署到指定的服务器上，运行时只需要加载指定的代码即可。

 <img src="./images/微前端实践方案及对比/微件化-方案示例.png">

#### 五、iframe

  `iFrame` 作为一个非常古老的，人人都觉得普通的技术，却一直很管用。

 > HTML 内联框架元素 `iframe` 表示嵌套的正在浏览的上下文，能有效地将另一个 HTML 页面嵌入到当前页面中。

 iframe 可以创建一个全新的独立的宿主环境，这意味着我们的前端应用之间可以相互独立运行。采用 iframe 有几个重要的前提：

 - 网站不需要 SEO 支持
 - 拥有相应的应用管理机制。

 在很多业务场景下，难免会遇到一些难以解决的问题，那么可以引入 iframe 来解决。

#### 六、Web Components

 Web Components 是一套不同的技术，允许开发者创建可重用的定制元素（它们的功能封装在代码之外）并且在您 Web 应用中使用它们。
在真正的项目上使用 Web Components技术，离现在还有一些距离，结合 Web Components 来构建前端应用，是一种面向未来演进的架构。或者说在未来可以采用这种方式来构建应用。

<img src="./images/微前端实践方案及对比/WebComponents-方案示例.png">

## 方案实施成本对比

<img src="./images/微前端实践方案及对比/微前端方案对比.png">

## 各方案常见问题

#### iframe方案
 
 1、页面加载问题

`iframe` 和主页面共享连接池，而浏览器对相同域的连接有限制，所以会影响页面的并行加载，阻塞 onload 事件。每次点击都需要重新加载，虽然可以采用 display:none 来做缓存，但是页面缓存过多会导致电脑卡顿。(无法解决)

 2、布局问题

`iframe` 必须给一个指定的高度，否则会塌陷。

*解决办法：子项目实时计算高度并通过 postMessage 发送给主页面，主页面动态设置 iframe 高度。有些情况会出现多个滚动条，用户体验不佳。*

3、弹窗及遮罩层问题

弹窗只能在 iframe 范围内垂直水平居中，没法在整个页面垂直水平居中。

 - *解决办法1：通过与框架页面消息同步解决，将弹窗消息发送给主页面，主页面来弹窗，对原项目改动大且影响原项目的使用。*

 - *解决办法2：修改弹窗的样式：隐藏遮罩层，修改弹窗的位置。*


4、iframe 内的 div 无法全屏

弹窗的全屏，指的是在浏览器可视区全屏。这个全屏指的是占满用户屏幕。

全屏方案，原生方法使用的是 Element.requestFullscreen()，插件：[vue-fullscreen](https://mirari.cc/2017/08/14/%E5%85%A8%E5%B1%8F%E5%88%87%E6%8D%A2%E7%BB%84%E4%BB%B6vue-fullscreen/)。当页面在 iframe 里面时，全屏会报错，且 dom 结构错乱。

<img src="./images/微前端实践方案及对比/iframe-error.png">

*解决方案：iframe 标签设置 allow="fullscreen" 属性即可*

5、浏览器前进/后退问题

`iframe` 和主页面共用一个浏览历史，iframe 会影响页面的前进后退。大部分时候正常，iframe 多次重定向则会导致浏览器的前进后退功能无法正常使用。并且 iframe 页面刷新会重置（比如说从列表页跳转到详情页，然后刷新，会返回到列表页），因为浏览器的地址栏没有变化，iframe 的 src 也没有变化。

6、iframe 加载失败的情况不好处理

非同源的 iframe 在火狐及 chorme 都不支持 onerror 事件。

 - *解决办法1：onload 事件里面判断页面的标题，是否 404 或者 500*

 - *解决办法2：使用 try catch 解决此问题，尝试获取 contentDocument 时将抛出异常。*

解决办法参考：[stackoverflow上的问题：Catch error if iframe src fails to load](https://stackoverflow.com/questions/15273042/catch-error-if-iframe-src-fails-to-load-error-refused-to-display-http-ww)

